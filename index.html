<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ğŸ™ï¸ Jarvis Asistente de Voz</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
/* ğŸ”´ Efecto de parpadeo del micrÃ³fono cuando no estÃ¡ escuchando */
@keyframes parpadeoMic {
  0%, 100% {
    box-shadow: 0 0 8px 2px rgba(255, 60, 60, 0.8);
    background: rgba(255, 255, 255, 0.1);
  }
  50% {
    box-shadow: 0 0 18px 6px rgba(255, 60, 60, 0.2);
    background: rgba(255, 0, 0, 0.15);
  }
}

#micBtn.parpadeando {
  animation: parpadeoMic 1.3s infinite ease-in-out;
  border: 2px solid rgba(255, 60, 60, 0.7);
}

#micBtn {
  position: fixed;
  top: 10px;
  right: 100px; /* antes estaba en 60px â†’ ahora queda mÃ¡s separado del ğŸ–¥ï¸ */
  background: rgba(255, 255, 255, 0.15);
  color: #e5e7eb;
  border: none;
  border-radius: 10px;
  font-size: 22px;
  padding: 8px 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 9999;
}

#micBtn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.1);
}

#graficas {
  background: #111827;
  color: #e5e7eb;
  padding: 40px 40px;
  border-radius: 16px;
  max-width: 900px;
  margin: 60px auto;
  box-shadow: 0 0 25px rgba(0, 0, 0, 0.55);
  display: flex;
  flex-direction: column;
  align-items: center;
}

#graficas h2 {
  text-align: center;
  margin-bottom: 30px;
  color: #60a5fa;
  font-family: 'Segoe UI', sans-serif;
  font-size: 1.6em;
  letter-spacing: 0.5px;
}

canvas {
  margin: 25px 0;
  background: #1f2937;
  border-radius: 14px;
  padding: 10px;
  width: 100%;
  max-width: 800px;
  height: 320px !important;
  box-sizing: border-box;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* efecto hover opcional, sutil */
canvas:hover {
  transform: scale(1.02);
  box-shadow: 0 0 25px rgba(96, 165, 250, 0.3);
}


#panelManual {
  margin-top: 40px;
}
#panelManual h2 {
  color: #0ff;
  margin-bottom: 10px;
}
#panelManual button {
  background: #0f0;
  color: #111;
  font-size: 1.1em;
  padding: 10px 25px;
  border-radius: 10px;
  margin: 8px;
  cursor: pointer;
  transition: 0.15s;
}
#panelManual button:hover {
  background: #5f5;
}
#panelFrecuencia {
  margin-top: 40px;
}
#panelFrecuencia h2 {
  color: #0ff;
  margin-bottom: 10px;
}
#panelFrecuencia .slider-section {
  margin-bottom: 20px;
}
#panelFrecuencia .manual-section {
  display: flex;
  justify-content: center;
  align-items: baseline; /* ğŸ”§ cambia center â†’ baseline para alineaciÃ³n visual */
  gap: 10px;
}

#panelFrecuencia input[type="number"] {
  background: #222;
  color: #0f0;
  font-size: 1.1em;
  text-align: center;
  border: none;
  border-radius: 10px;
  padding: 10px 0;           /* ğŸ”§ ajusta padding para nivelar verticalmente */
  width: 120px;
  height: 45px;
  box-sizing: border-box;
  position: relative;
  top: 0px;                 /* ğŸ”§ leve ajuste de posiciÃ³n vertical */
}

#panelFrecuencia button {
  background: #0f0;
  color: #111;
  font-size: 1.1em;
  padding: 10px 0;
  width: 120px;
  height: 45px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: 0.15s;
}

#panelFrecuencia button:hover {
  background: #5f5;
}

body {
  font-family: Arial, sans-serif;
  background: #111;
  color: #0f0;
  text-align: center;
  padding-top: 60px;
}
h1 { font-size: 2em; margin: 0; }
#texto { font-size: 1.1em; margin-top: 18px; white-space: pre-line; }
.status { color: #0ff; font-style: italic; margin-top: 8px; }
button {
  background: #0f0; color: #111; font-size: 1.05em;
  padding: 10px 22px; border: none; border-radius: 10px;
  cursor: pointer; margin-top: 18px; transition: 0.15s;
}
button:hover { background: #5f5; }
#nota { font-size: 0.9em; color: #9f9; margin-top: 6px; }
/* ====== BOTÃ“N PANTALLA COMPLETA ====== */
#fullscreenBtn {
  position: fixed;
  top: 10px;
  right: 10px;
  background: rgba(255, 255, 255, 0.15);
  color: #e5e7eb;
  border: none;
  border-radius: 10px;
  font-size: 22px;
  padding: 8px 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 9999;
}

#fullscreenBtn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.1);
}
</style>
</head>
<body>
<!-- ğŸ–¥ï¸ BotÃ³n para modo pantalla completa -->
<button id="fullscreenBtn" title="Pantalla completa">ğŸ–¥ï¸</button>
<!-- ğŸ™ï¸ BotÃ³n activar/desactivar micrÃ³fono -->
<button id="micBtn" title="Activar micrÃ³fono">ğŸ™ï¸</button>
<h1>ğŸ™ï¸ Jarvis Asistente</h1>
<p id="texto">ğŸ• Esperando â€œhola jarvichâ€...</p>
<p class="status" id="estado">MicrÃ³fono activo ğŸ§</p>
<button id="activarSonido">ğŸ”Š Activar sonido</button>
<p id="nota">Tip: Haz clic en "Activar sonido" una vez si el audio no suena automÃ¡ticamente.</p>
<!-- ğŸ”˜ Panel de control manual -->
<div id="panelManual" style="margin-top: 40px;">
  <h2>âš™ï¸ Control Manual</h2>
  <button id="btnStart">ğŸŸ¢ START</button>
  <button id="btnStop">ğŸ”´ STOP</button>
</div>
<!-- ğŸšï¸ Control de Frecuencia -->
<div id="panelFrecuencia">
  <h2>ğŸšï¸ Control de Frecuencia</h2>
  
  <div class="slider-section">
    <label for="sliderFreq">Frecuencia (Hz):</label><br>
    <input type="range" id="sliderFreq" min="0" max="60" step="0.1" value="0" style="width:70%;margin-top:10px;">
    <p id="valorSlider">ğŸ”¸ 0.00 Hz</p>
  </div>

  <div class="manual-section">
    <input type="number" id="inputFreq" min="0" max="60" step="0.01" value="0" style="width:100px;padding:6px;border-radius:6px;border:none;text-align:center;">
    <button id="btnSetFreq">âš¡ SET</button>
  </div>
</div>
<div id="panelLecturas" style="margin-top:40px;">
  <h2>ğŸ“ˆ Lecturas del Variador</h2>
  <pre id="lecturas">Esperando datos...</pre>
</div>
<div id="graficas" style="margin-top: 40px;">
  <h2>ğŸ“Š Monitoreo en Tiempo Real</h2>
  <canvas id="graf_f" height="150"></canvas>
  <canvas id="graf_vout" height="150"></canvas>
  <canvas id="graf_rpm" height="150"></canvas>
  <canvas id="graf_vin" height="150"></canvas>  
</div>

<script>
/* ===========================
   Jarvis voz â†’ limpia comando
   =========================== */

const texto = document.getElementById('texto');
const estado = document.getElementById('estado');
const botonSonido = document.getElementById('activarSonido');

let modoComando = false;
let temporizador = null;
let audioDesbloqueado = false;
// --- ConexiÃ³n MQTT ---
const topic = "test/matlab/demoYefri";  // puedes cambiarlo si quieres
const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");

client.on("connect", () => {
  console.log("âœ… Conectado a broker MQTT HiveMQ");
  estado.innerText = "ğŸŒ Conectado a MQTT (HiveMQ)";
});
client.on("reconnect", () => {
  console.log("â™»ï¸ Reconectando a MQTT...");
  estado.innerText = "â™»ï¸ Reconectando a MQTT...";
});
client.on("close", () => {
  console.log("ğŸ”Œ ConexiÃ³n MQTT cerrada");
  estado.innerText = "ğŸ”Œ Desconectado de MQTT";
});
client.subscribe("test/matlab/demoYefri/data");

client.on("message", (topic, message) => {
  if (topic === "test/matlab/demoYefri/data") {
    try {
      const data = JSON.parse(message.toString());
      console.log("ğŸ“Š Datos recibidos:", data);
      actualizarGraficas(data);
    } catch (err) {
      console.warn("âš ï¸ Error parseando JSON:", err.message);
    }
  }
});

client.on("error", (err) => {
  console.error("âš ï¸ Error MQTT:", err);
  estado.innerText = "âŒ Error al conectar MQTT";
});
// === CONFIGURACIÃ“N DE GRÃFICAS ===
const tiempoMax = 20; // segundos de historial visible
const charts = {};

function crearGrafica(id, label, color) {
  const ctx = document.getElementById(id).getContext("2d");
  return new Chart(ctx, {
    type: "line",
    data: {
      labels: [],
      datasets: [{
        label: label,
        borderColor: color,
        backgroundColor: color + "33",
        data: [],
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      animation: false,
      scales: {
        x: {
          title: { display: true, text: "Tiempo" }
        },
        y: {
          title: { display: true, text: label },
          beginAtZero: true
        }
      },
      plugins: {
        legend: { labels: { color: "#e5e7eb" } }
      }
    }
  });
}

// Crear las grÃ¡ficas
charts.f = crearGrafica("graf_f", "Frecuencia (Hz)", "#34d399");
charts.vout = crearGrafica("graf_vout", "Voltaje Salida (V)", "#60a5fa");
charts.rpm = crearGrafica("graf_rpm", "RPM", "#f87171");
charts.vin = crearGrafica("graf_vin", "Voltaje Entrada (V)", "#fbbf24");

// === FUNCIÃ“N PARA ACTUALIZAR DATOS ===
function actualizarGraficas(data) {
  const tiempo = data.timestamp || new Date().toLocaleTimeString();

  Object.entries({
    f: data.f,
    vout: data.v_out,
    vin: data.v_in,
    rpm: data.rpm
  }).forEach(([key, val]) => {
    const chart = charts[key];
    if (!chart) return;

    chart.data.labels.push(tiempo);
    chart.data.datasets[0].data.push(val);

    if (chart.data.labels.length > tiempoMax) {
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }

    chart.update();
  });
}

// --- Wake words (variantes completas) ---
const wakeWords = [
  'hola jarvis','ola jarvis','hola yarvis','ola yarvis',
  'hola jervis','ola jervis','hola yervis','ola yervis',
  'hola jarvich','ola jarvich','hola yarvich','ola yarvich',
  'hola llavich','ola llavich','hola llarvich','ola llarvich',
  'hola jharvis','ola jharvis','hola jharvich','ola jharvich',
  'hola yharvis','ola yharvis','hola yharvich','ola yharvich',
  'holarvich','holarvis','hola yarbis','ola yarbis',
  'hola yaris','ola yaris','hola yarbit','hola yarbis',
  'hola yarlis','ola yarlis','hola yarmis','ola yarmis',
  'hola jerry','ola jerry','hola jerry','ola jerry',
  'hola yerlich','ola yerlich','hola yerlich','ola yerlich',
  'hola yarbich','ola yarbich','hola llarbich','ola yarbeach',
  'jarvis','yarvis','jervis','yervis','jarvich','yarvich',
  'llavich','llarvich','jharvis','jharvich','yharvis','yharvich',
  'holarvich','holarvis','yarbis','yaris','yarbit','yarbis',
  'hola llaves','ola llaves','hola yaves','ola yaves',
  'hola llaes','ola llaes','hola llave','ola llave',
  'hola llarbes','ola llarbes','hola llarvis','ola llarvis',
  'hola llabers','ola llabers','hola ylabes','ola ylabes',
  'holallaves','holayaves','ola llabers','ola llabes',
  'llaves','yaves','llaes','llabe','llabes','ylabes',
  'llabers','llabes','llabiz','llabis','llabers','yabis',
  'o la llaves','o la yaves','ol allaves','olayaves','llarvys',
  'holallabes','holayabes','llavish','yavish','llabesito',
  'yarlis','yarmis','jerry','yerlich','yarbich','llarbich','yarbeach','yarvich',
  'o la jarvich','llarvis','o la yarvich','ol ayarvich','olayarvich'
];

// --- Variantes completas de ENCENDIDO/APAGADO (para mayor robustez en HTML) ---
const cmdOnList = [
  "prende motor","prender motor","enciende motor","encender motor",
  "activa motor","activar motor","motor on","enciende el motor",
  "prende el motor","prender el motor","activa el motor","activar el motor",
  "arranca motor","arrancar motor","arranca el motor","arrancar el motor",
  "enciendelo","enciÃ©ndelo","prendelo","prÃ©ndelo",
  "prende variador","prender variador","enciende variador","encender variador",
  "activa variador","activar variador","variador on","enciende el variador",
  "prende el variador","prender el variador","activa el variador","activar el variador",
  "arranca variador","arrancar variador","arranca el variador","arrancar el variador",
  "enciendelo","enciÃ©ndelo","prendelo","prÃ©ndelo",
  "enciende mÃ¡quina","prende mÃ¡quina","arranca mÃ¡quina",
  "variador adelante","inicia variador","iniciar variador","inicia el variador",
  "enciende mÃ¡quina","prende mÃ¡quina","arranca mÃ¡quina",
  "motor adelante","inicia motor","iniciar motor","inicia el motor"
];

const cmdOffList = [
  "apaga motor","apagar motor","desactiva motor","desactivar motor",
  "detiene motor","detener motor","para motor","motor off",
  "apaga el motor","apagar el motor","desactiva el motor","desactivar el motor",
  "detiene el motor","detener el motor","para el motor",
  "detÃ©n motor","detÃ©n el motor","deten el motor",
  "apagalo","apÃ¡galo","desactivalo","desactÃ­valo",
  "para mÃ¡quina","detiene mÃ¡quina","apaga mÃ¡quina","stop motor",
  "apaga variador","apagar variador","desactiva variador","desactivar variador",
  "detiene variador","detener variador","para variador","variador off",
  "apaga el variador","apagar el variador","desactiva el variador","desactivar el variador",
  "detiene el variador","detener el variador","para el variador",
  "detÃ©n variador","detÃ©n el variador","deten el variador",
  "frena motor","frenar motor","frena la mÃ¡quina","detÃ©n la mÃ¡quina"
];

// --- Util: reproducir bip ---
function reproducirBip(frecuencia, duracion) {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = 'sine';
  o.frequency.value = frecuencia;
  o.connect(g);
  g.connect(ctx.destination);
  o.start();
  g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + duracion);
  setTimeout(() => o.stop(), duracion * 1000);
}

// --- BotÃ³n para desbloquear audio (interacciÃ³n requerida por navegadores) ---
botonSonido.onclick = () => {
  reproducirBip(600, 0.18);
  audioDesbloqueado = true;
  botonSonido.style.display = 'none';
  texto.innerText = 'âœ… Sonido activado. Esperando â€œhola jarvichâ€â€¦';
};

// --- SpeechRecognition setup ---
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SpeechRecognition) {
  texto.innerText = 'âš ï¸ Tu navegador no soporta SpeechRecognition.';
  throw new Error('SpeechRecognition no soportado');
}
const recog = new SpeechRecognition();
recog.lang = 'es-ES';
recog.continuous = true;
recog.interimResults = false;

// --- Normaliza y chequea si una frase contiene alguna variante ---
function containsAnyVariant(frase, variants) {
  for (let v of variants) {
    if (frase.includes(v)) return true;
  }
  return false;
}

// --- FunciÃ³n que toma la frase y devuelve el comando limpio o null ---
function limpiarComando(fraseOriginal) {
  // normalizar acentos y mayÃºsc/minÃºsc
  let s = fraseOriginal.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

  // 1) Si coincide con cualquiera de las variantes de ON (buscamos coincidencia parcial con array)
  for (let v of cmdOnList) {
    if (s.includes(v)) return "prende motor";
  }

  // 2) OFF
  for (let v of cmdOffList) {
    if (s.includes(v)) return "apaga motor";
  }

// 3) FRECUENCIA: detecta nÃºmero (ej: "frecuencia 45.5", "poner frecuencia 22,45", "45.5 hz")
  const tieneNumero = /\d+([.,]\d+)?/.test(s); // detecta si hay un nÃºmero en la frase
  if (
    s.includes("frecuencia") || s.includes("hz") || s.includes("hertz") ||
    s.includes("herz") || s.includes("frecuncia") || s.includes("frecuensia") ||
    s.includes("frecuecia") || s.includes("frecuancia") ||
    s.includes("setear") || s.includes("setea") ||
    s.includes("establecer") || s.includes("establece") ||
    tieneNumero // ğŸ‘ˆ ahora basta con que haya nÃºmero para que entre
  ) {
    // extraer primer nÃºmero decimal que encuentre
    const m = s.match(/(\d+([.,]\d+)?)/);
    if (m) {
      const num = m[1].replace(",", ".");
      // lÃ­mite de seguridad: 0..60
      const val = parseFloat(num);
      if (!isNaN(val)) {
        const valClamped = Math.max(0, Math.min(60, val));
        return valClamped.toFixed(
          (num.indexOf('.') > -1 || num.indexOf(',') > -1)
            ? num.split(/[.,]/)[1].length
            : 0
        );
      }
    }
  }

  // no reconocido
  return null;
}
// --- Manejo de resultados de reconocimiento ---
recog.onresult = (event) => {
  const frase = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
  console.log('ğŸ—£ï¸ Dijo:', frase);
  texto.innerText = 'ğŸ—£ï¸ ' + frase;

  if (!modoComando) {
    // comprobar wake words
    if (containsAnyVariant(frase, wakeWords)) {
      modoComando = true;
      texto.innerText = 'ğŸ¤– SÃ­, mi seÃ±or... preparando escucha.';
      micBtn.classList.remove('parpadeando');
      recog.stop();
      if (audioDesbloqueado) {
        reproducirBip(500, 0.25);
        const audio = new Audio('respuesta_jarvis.wav?v=' + new Date().getTime());
        audio.play().catch(e => console.warn('âš ï¸ Error audio:', e));
        audio.onended = () => {
          reproducirBip(500, 0.25);
          try { recog.start(); } catch(e) {}
          texto.innerText = 'ğŸ§ Te escucho durante 5 segundos...';
          // 5 segundos para el comando
          temporizador = setTimeout(() => {
            modoComando = false;
            try { recog.stop(); } catch(e) {}
            texto.innerText = 'ğŸ• Tiempo agotado. Esperando â€œhola jarvisâ€â€¦';
            micBtn.classList.add('parpadeando');
          }, 6000);
        };
      } else {
        // sin audio desbloqueado: arrancar escucha de inmediato
        try { recog.start(); } catch(e) {}
        texto.innerText = 'ğŸ§ Te escucho durante 5 segundos...';
        temporizador = setTimeout(() => {
          modoComando = false;
          try { recog.stop(); } catch(e) {}
          texto.innerText = 'ğŸ• Tiempo agotado. Esperando â€œhola jarvisâ€â€¦';
        }, 5000);
      }
    }
  } else {
    // ya en modo comando â†’ procesar y enviar solo el comando limpio
    clearTimeout(temporizador);
    recog.stop();

    const comandoLimpio = limpiarComando(frase);
if (comandoLimpio) {
  texto.innerText = 'âœ… Comando limpio: ' + comandoLimpio;

  // Si el comando es un nÃºmero (frecuencia), actualizar UI (slider + input + texto)
  if (!isNaN(comandoLimpio)) {
    const valor = parseFloat(comandoLimpio);
    // limitar por seguridad (0..60)
    const valorClamped = Math.max(0, Math.min(60, valor));
    slider.value = valorClamped;
    inputFreq.value = valorClamped.toFixed(2);
    valorSlider.innerText = `ğŸ”¸ ${valorClamped.toFixed(2)} Hz`;
    console.log("ğŸšï¸ Frecuencia actualizada visualmente desde voz:", valorClamped);
    // confirmaciÃ³n sonora opcional
    reproducirBip(650, 0.15);
  }

  if (client && client.connected) {
    client.publish(topic, comandoLimpio);
    console.log("ğŸ“¤ Enviado por MQTT:", comandoLimpio);
  } else {
    console.warn("âš ï¸ Cliente MQTT no conectado.");
  }
  modoComando = false;          // Salimos del modo comando inmediatamente
  try { recog.stop(); } catch(e) {}
  clearTimeout(temporizador);   // Cancelar cualquier temporizador pendiente
  texto.innerText += '\nğŸ¤ Reconocimiento finalizado. Presiona ğŸ™ï¸';
  micBtn.classList.add('parpadeando'); // ğŸ”´ Volver a parpadear despuÃ©s del comando
} else {
    texto.innerText = `â“ No se reconociÃ³ un comando vÃ¡lido.\n(ğŸ“¢ Reconocido: "${frase}")`;
    console.warn("ğŸ—£ï¸ Dijo pero no coincidiÃ³ con ningÃºn comando:", frase);
    modoComando = false;            // âœ… Reinicia el modo comando
    micBtn.classList.add('parpadeando'); // ğŸ”´ Jarvis vuelve a inactivo
    texto.innerText += '\nğŸ¤ Reconocimiento finalizado. Presiona ğŸ™ï¸';
}
  }
};
micBtn.classList.add('parpadeando'); // ğŸ”´ comienza parpadeando al iniciar
</script>
<script>
// =============================
// ğŸ”˜ Botones manuales START / STOP
// =============================
document.getElementById('btnStart').onclick = () => {
  if (client && client.connected) {
    client.publish(topic, "prende motor");
    console.log("ğŸ“¤ Enviado MQTT: prende motor (manual)");
    texto.innerText = "âœ… Motor encendido manualmente.";
    reproducirBip(700, 0.2);
  } else {
    console.warn("âš ï¸ Cliente MQTT no conectado.");
  }
};

document.getElementById('btnStop').onclick = () => {
  if (client && client.connected) {
    client.publish(topic, "apaga motor");
    console.log("ğŸ“¤ Enviado MQTT: apaga motor (manual)");
    texto.innerText = "ğŸ›‘ Motor apagado manualmente.";
    reproducirBip(300, 0.2);
  } else {
    console.warn("âš ï¸ Cliente MQTT no conectado.");
  }
};
// =============================
// ğŸšï¸ Control de Frecuencia
// =============================

const slider = document.getElementById('sliderFreq');
const valorSlider = document.getElementById('valorSlider');
const inputFreq = document.getElementById('inputFreq');
const btnSetFreq = document.getElementById('btnSetFreq');

// variable para controlar el retardo
let enviarTimeout = null;

// --- Cuando se mueve el slider ---
slider.oninput = () => {
  const valor = parseFloat(slider.value).toFixed(2);
  valorSlider.innerText = `ğŸ”¸ ${valor} Hz`;
  inputFreq.value = valor; // ğŸ”„ tambiÃ©n actualiza el input numÃ©rico

  // ğŸ” cancelar el temporizador anterior (si el usuario sigue moviendo)
  clearTimeout(enviarTimeout);

  // ğŸ•’ programar un nuevo envÃ­o con 300 ms de retardo
  enviarTimeout = setTimeout(() => {
    if (client && client.connected) {
      client.publish(topic, valor);
      console.log("ğŸ“¤ Enviado MQTT (slider con retardo):", valor);
    } else {
      console.warn("âš ï¸ Cliente MQTT no conectado.");
    }
  }, 300); // <--- ajusta este tiempo si quieres mÃ¡s/menos sensibilidad
};

// --- Cuando se presiona el botÃ³n SET ---
btnSetFreq.onclick = () => {
  let valor = parseFloat(inputFreq.value);
  if (isNaN(valor)) valor = 0;
  valor = Math.min(60, Math.max(0, valor));
  inputFreq.value = valor.toFixed(2);
  slider.value = valor;
  valorSlider.innerText = `ğŸ”¸ ${valor.toFixed(2)} Hz`;

  if (client && client.connected) {
    client.publish(topic, valor.toFixed(2));
    console.log("ğŸ“¤ Enviado MQTT (manual SET):", valor.toFixed(2));
    texto.innerText = `âœ… Frecuencia seteada: ${valor.toFixed(2)} Hz`;
    reproducirBip(650, 0.15);
  } else {
    console.warn("âš ï¸ Cliente MQTT no conectado.");
  }
};
// === SuscripciÃ³n para recibir datos del variador (desde MATLAB) ===
client.subscribe("test/matlab/demoYefri/data");

client.on("message", (topic, message) => {
  if (topic === "test/matlab/demoYefri/data") {
    try {
      const data = JSON.parse(message.toString());
      console.log("ğŸ“Š Datos desde MATLAB:", data);
      // Muestra en el HTML
      document.getElementById("lecturas").innerText =
        `Frecuencia: ${data.f} Hz\n` +
        `V_OUT: ${data.v_out} V\n` +
        `RPM: ${data.rpm}\n` +
        `V_IN: ${data.v_in} V\n` +      
        `â±ï¸ ${data.timestamp}`;
    } catch (e) {
      console.error("âš ï¸ Error leyendo datos MQTT:", e.message);
    }
  }
});
</script>
<script>
// =============================
// ğŸ–¥ï¸ Control de Pantalla Completa
// =============================
const fullscreenBtn = document.getElementById("fullscreenBtn");

fullscreenBtn.addEventListener("click", async () => {
  if (!document.fullscreenElement) {
    try {
      await document.documentElement.requestFullscreen();
      fullscreenBtn.textContent = "ğŸ–¥ï¸";
      fullscreenBtn.title = "Salir de pantalla completa";
    } catch (err) {
      console.warn("No se pudo activar pantalla completa:", err);
    }
  } else {
    await document.exitFullscreen();
    fullscreenBtn.textContent = "ğŸ–¥ï¸";
    fullscreenBtn.title = "Pantalla completa";
  }
});

// ğŸ™ï¸ Control de MicrÃ³fono Manual
// =============================
const micBtn = document.getElementById("micBtn");

micBtn.addEventListener("click", () => {
  try {
    recog.start();
    micBtn.classList.remove('parpadeando'); // ğŸ‘ˆ Detener parpadeo mientras escucha
    micBtn.textContent = "ğŸ™ï¸";
    micBtn.title = "MicrÃ³fono activado";
    estado.innerText = "ğŸ§ MicrÃ³fono activado nuevamente.";
  } catch (e) {
    console.warn("Error al iniciar micrÃ³fono:", e);
    alert("No se pudo iniciar el micrÃ³fono, verifica los permisos.");
  }
});

</script>
</body>
</html>

